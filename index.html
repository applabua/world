<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GOLDEN MILLION — Get in now, be remembered beside legends.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{ --bg:#fff; --ink:#111; --muted:#6b7280; --outline:#cfd6e3; --overlay:rgba(0,0,0,.5); --hover:rgba(0,0,0,.08); }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:fixed;inset:0 0 auto 0;z-index:20;display:flex;justify-content:center;padding:8px 12px;pointer-events:none}
  .cta{pointer-events:auto;display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.96);border:1px solid #e7ebf2;border-radius:999px;padding:8px 14px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
  .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(#ffd24d,#e1b526)}
  .cta b{font-weight:800}.cta span{color:var(--muted)}
  #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{display:block; max-width:100vw; max-height:100vh; width:100%; height:100%; cursor:default}

  /* Modals */
  .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.on{display:flex}
  .card{width:min(720px,92vw);background:#fff;border:1px solid #e7ebf2;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:16px;animation:pop .22s ease-out both}
  @keyframes pop{from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1}}
  .title{margin:0 0 6px 0;font-weight:800}
  .sub{margin:0 0 12px 0;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .drop{min-height:160px;border:1px dashed #cfd3da;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#666;background:#fafafa;cursor:pointer}
  .thumb{max-width:100%;max-height:340px;border-radius:12px;border:1px solid #e7ebf2;display:block}
  .input{width:100%;padding:10px 12px;border:1px solid #e7ebf2;border-radius:10px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .btn{appearance:none;border:1px solid #e7ebf2;background:#fff;color:#111;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{border-color:#111;background:#111;color:#fff}
  .zoomHint{position:fixed;right:10px;bottom:10px;background:rgba(255,255,255,.9);border:1px solid #e7ebf2;border-radius:10px;padding:6px 8px;color:#555}
</style>
</head>
<body>
<header>
  <div class="cta"><div class="dot"></div><b>GOLDEN MILLION</b><span>Get in now — be remembered beside legends.</span></div>
</header>

<div id="stage"><canvas id="wall"></canvas></div>
<div class="zoomHint">Zoom: mouse wheel or <b>+</b>/<b>−</b></div>

<!-- VIEW -->
<div class="overlay" id="viewOverlay">
  <div class="card">
    <h3 class="title" id="viewTitle">Legend</h3>
    <p class="sub" id="viewSub">“A short line for history.”</p>
    <img id="viewImg" class="thumb" alt="">
    <div class="actions"><button class="btn" id="viewClose">Close</button></div>
  </div>
</div>

<!-- ADD -->
<div class="overlay" id="addOverlay">
  <div class="card">
    <h3 class="title">Claim your golden spot — $1 / year (test mode)</h3>
    <p class="sub">Add your image and a short line about yourself. Saved locally in your browser for now.</p>
    <div class="row">
      <div class="col">
        <div class="drop" id="drop"><input type="file" id="file" accept="image/*" style="display:none"><span id="dropText">Drop an image here (or click)</span></div>
        <img id="preview" class="thumb" alt="" style="display:none;margin-top:8px">
      </div>
      <div class="col">
        <label class="sub" for="desc">Your short line (max 80 chars)</label>
        <input class="input" id="desc" maxlength="80" placeholder="I was here. 2025.">
      </div>
    </div>
    <div class="actions"><button class="btn" id="addCancel">Cancel</button><button class="btn primary" id="addSave">Save (test)</button></div>
  </div>
</div>

<script>
/* ========================= CONFIG ========================= */
const CAN = document.getElementById('wall');
const CTX = CAN.getContext('2d', {alpha:false});
let DPR = Math.max(1, window.devicePixelRatio || 1);

const WORLD = { cells:1000, size:1000 }; // логическая «стена»: 1000×1000 (1,000,000 мест)
const TILE_COUNT = 3000;                 // мозаика разных размеров
const LEGENDS_COUNT = 100;               // топ-100 под легенды
const LS_KEY = 'gm_canvas_claims_v2';

/* =================== RNG & GEOMETRY =================== */
let SEED = 987654321>>>0;
function srand(){ SEED = (SEED*1664525 + 1013904223)>>>0; return SEED/4294967296; }
function rint(a,b){ return Math.floor(a + srand()*(b-a+1)); }
const rect = (x,y,w,h)=>({id:0,x,y,w,h,area:w*h});
function splitOne(r){
  const horiz = r.w >= r.h;
  if (horiz){
    const min = Math.max(20, Math.floor(r.w*0.33));
    const max = Math.min(r.w-20, Math.floor(r.w*0.67));
    if (max<=min) return [r];
    const cut = rint(min,max);
    return [ rect(r.x, r.y, cut, r.h), rect(r.x+cut, r.y, r.w-cut, r.h) ];
  } else {
    const min = Math.max(20, Math.floor(r.h*0.33));
    const max = Math.min(r.h-20, Math.floor(r.h*0.67));
    if (max<=min) return [r];
    const cut = rint(min,max);
    return [ rect(r.x, r.y, r.w, cut), rect(r.x, r.y+cut, r.w, r.h-cut) ];
  }
}
function buildMosaic(target){
  const list = [ rect(0,0, WORLD.size, WORLD.size) ];
  while(list.length < target){
    let idx=-1, best=-1;
    for(let i=0;i<list.length;i++){
      const r=list[i]; if (r.w>40 && r.h>40 && r.area>best){ best=r.area; idx=i; }
    }
    if (idx===-1) break;
    const r=list.splice(idx,1)[0];
    const [a,b]=splitOne(r);
    if (b){ a.area=a.w*a.h; b.area=b.w*b.h; list.push(a,b); } else list.push(r);
  }
  for(let k=0;k<list.length;k++){
    const r=list[k], asp=r.w/r.h;
    if (asp>3 || asp<0.33){ const p=splitOne(r); if (p.length===2){ list.splice(k,1,p[0],p[1]); k--; } }
  }
  while(list.length>target) list.pop();
  list.forEach((r,i)=> r.id=i);
  return list;
}
let tiles = buildMosaic(TILE_COUNT);

/* =================== LEGENDS (images + desc) =================== */
const LEGEND_PHOTOS = {
  "Napoleon Bonaparte":"https://upload.wikimedia.org/wikipedia/commons/5/50/Napoleon_Bonaparte_by_Jean-Auguste-Dominique_Ingres%2C_1806.jpg",
  "Donald Trump":"https://upload.wikimedia.org/wikipedia/commons/5/56/Donald_Trump_official_portrait.jpg",
  "Volodymyr Zelenskyy":"https://upload.wikimedia.org/wikipedia/commons/2/2e/Volodymyr_Zelensky_Official_portrait.jpg",
  "Joe Biden":"https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg",
  "Elon Musk":"https://upload.wikimedia.org/wikipedia/commons/4/49/Elon_Musk_2015.jpg",
  "George Washington":"https://upload.wikimedia.org/wikipedia/commons/6/6f/George_Washington_by_Gilbert_Stuart%2C_1797.jpg",
  "Abraham Lincoln":"https://upload.wikimedia.org/wikipedia/commons/a/a3/Abraham_Lincoln_O-77_matte_collodion_print.jpg",
  "Winston Churchill":"https://upload.wikimedia.org/wikipedia/commons/1/1e/Churchill_portrait_NYP_45063.jpg",
  "Martin Luther King Jr.":"https://upload.wikimedia.org/wikipedia/commons/1/1e/Martin_Luther_King_Jr_NYWTS_3.jpg",
  "Leonardo da Vinci":"https://upload.wikimedia.org/wikipedia/commons/6/6d/Leonardo_self.jpg",
  "Marie Curie":"https://upload.wikimedia.org/wikipedia/commons/7/7e/Marie_Curie_c1920.jpg",
  "Albert Einstein":"https://upload.wikimedia.org/wikipedia/commons/d/d3/Albert_Einstein_Head.jpg",
  "Nikola Tesla":"https://upload.wikimedia.org/wikipedia/commons/d/d4/N.Tesla.JPG",
  "Angela Merkel":"https://upload.wikimedia.org/wikipedia/commons/9/90/Angela_Merkel_Juli_2010_-_3zu4.jpg",
  "Barack Obama":"https://upload.wikimedia.org/wikipedia/commons/8/8d/President_Barack_Obama.jpg",
  "Steve Jobs":"https://upload.wikimedia.org/wikipedia/commons/8/80/Steve_Jobs_Headshot_2010-CROP2.jpg",
  "Bill Gates":"https://upload.wikimedia.org/wikipedia/commons/a/a0/Bill_Gates_2018.jpg",
  "Jeff Bezos":"https://upload.wikimedia.org/wikipedia/commons/3/35/Jeff_Bezos_cropped.jpg"
};
const LEGEND_DESC = {
  "Napoleon Bonaparte":"French statesman and military leader.",
  "Donald Trump":"45th President of the United States.",
  "Volodymyr Zelenskyy":"President of Ukraine.",
  "Joe Biden":"46th President of the United States.",
  "Elon Musk":"Entrepreneur and engineer.",
  "George Washington":"1st U.S. President.",
  "Abraham Lincoln":"16th U.S. President.",
  "Winston Churchill":"UK Prime Minister during WWII.",
  "Martin Luther King Jr.":"Civil rights leader.",
  "Leonardo da Vinci":"Renaissance polymath.",
  "Marie Curie":"Pioneer in radioactivity.",
  "Albert Einstein":"Theoretical physicist.",
  "Nikola Tesla":"Inventor and electrical engineer.",
  "Angela Merkel":"Chancellor of Germany (2005–2021).",
  "Barack Obama":"44th U.S. President.",
  "Steve Jobs":"Apple co-founder.",
  "Bill Gates":"Microsoft co-founder.",
  "Jeff Bezos":"Amazon founder."
};
const LEGEND_NAMES = Object.keys(LEGEND_PHOTOS).concat([
  "Nelson Mandela","Julius Caesar","Pablo Picasso","Vincent van Gogh","Michelangelo",
  "Ada Lovelace","Alan Turing","Grace Hopper","Katherine Johnson","Hedy Lamarr",
  "Charles Darwin","Carl Sagan","Johannes Kepler","Niels Bohr","William Shakespeare",
  "Homer","Dante Alighieri","Johann Sebastian Bach","Ludwig van Beethoven","Wolfgang Amadeus Mozart",
  "Leo Tolstoy","Fyodor Dostoevsky","Ernest Hemingway","Agatha Christie","Serena Williams",
  "Michael Jordan","Kobe Bryant","Lionel Messi","Cristiano Ronaldo","Pelé",
  "Usain Bolt","Bruce Lee","Jackie Chan","Hayao Miyazaki","Akira Kurosawa",
  "Steven Spielberg","George Lucas","Quentin Tarantino","James Cameron","Mother Teresa",
  "Florence Nightingale","Yuri Gagarin","Neil Armstrong","Jane Goodall","Socrates",
  "Plato","Aristotle","Confucius","Sun Tzu","Genghis Khan",
  "Alexander the Great","Queen Elizabeth II","Joan of Arc","Catherine the Great","Sheryl Sandberg",
  "Satya Nadella","Sundar Pichai","Tim Cook","Susan Wojcicki","Desmond Tutu",
  "Lech Wałęsa","Václav Havel","J.R.R. Tolkien","George R. R. Martin","J.K. Rowling",
  "Haruki Murakami","Gabriel García Márquez","Oprah Winfrey","Greta Thunberg","Galileo Galilei"
]).slice(0,LEGENDS_COUNT);

/* =================== STORAGE =================== */
let claims = {};
try{ claims = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }catch(e){ claims = {}; }
function persist(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(claims)); }catch(e){ alert("Storage quota exceeded. Try a smaller image."); }}

/* =================== PREFILL LEGENDS =================== */
(function prefill(){
  const have = Object.values(claims).filter(v=>v && v.legend).length;
  if (have >= LEGENDS_COUNT) return;
  const sorted = [...tiles].sort((a,b)=>b.area-a.area).slice(0,LEGENDS_COUNT);
  sorted.forEach((t,i)=>{
    const name = LEGEND_NAMES[i] || "Legend";
    const url  = LEGEND_PHOTOS[name];
    claims[t.id] = {
      img: url || initialsAvatar(name, Math.max(300, t.w), Math.max(300, t.h)),
      name,
      desc: LEGEND_DESC[name] || "Legend.",
      legend: true
    };
  });
  persist();
})();

/* =================== CANVAS RENDER =================== */
let W=0,H=0,SCALE=1, hoverId=null;
function resize(){
  const vw = Math.max(360, window.innerWidth);
  const vh = Math.max(360, window.innerHeight);
  W = Math.floor(vw*DPR); H = Math.floor(vh*DPR);
  CAN.width = W; CAN.height = H;
  CAN.style.width = vw+'px'; CAN.style.height = vh+'px';
  fitToView(); draw();
}
window.addEventListener('resize', resize);

function fitToView(){
  // вписываем всю стену, без панорамирования
  SCALE = Math.min(W, H) / WORLD.size;
}
function setZoom(mult){
  // Зум без панорамирования: просто меняем масштаб и перерисовываем
  SCALE = Math.max(0.2, Math.min(3, SCALE*mult));
  draw();
}

const imgCache = new Map();
function loadImg(src){
  if (imgCache.has(src)) return imgCache.get(src);
  const p = new Promise((res,rej)=>{
    const im = new Image();
    im.crossOrigin = "anonymous";
    im.referrerPolicy = "no-referrer";
    im.onload = ()=>res(im);
    im.onerror = ()=>rej(new Error('img-load-fail'));
    im.src = src;
  });
  imgCache.set(src,p); return p;
}

function initialsAvatar(name,w,h){
  const init = name.split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase();
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
    <stop offset='0%' stop-color='#fff2b2'/><stop offset='100%' stop-color='#e4c45e'/>
  </linearGradient></defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
        font-family='system-ui,Arial' font-size='${Math.floor(Math.min(w,h)*0.35)}'
        font-weight='800' fill='#111'>${init}</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

async function drawCover(src, name, x,y,w,h){
  // КАРТИНКА строго в границах плитки (clip)
  CTX.save();
  CTX.beginPath(); CTX.rect(x,y,w,h); CTX.clip(); // строгая обрезка
  try{
    const im = await loadImg(src);
    const r = Math.max(w/im.width, h/im.height);
    const iw = im.width*r, ih = im.height*r;
    const ix = x + (w - iw)/2, iy = y + (h - ih)/2;
    CTX.fillStyle="#fff"; CTX.fillRect(x,y,w,h);
    CTX.drawImage(im, ix, iy, iw, ih);
  }catch(e){
    // fallback — генерим аватар с инициалами
    const av = new Image();
    av.onload = ()=>{ CTX.drawImage(av,x,y,w,h); CTX.restore(); };
    av.src = initialsAvatar(name||'Member', Math.max(200,w), Math.max(200,h));
    CTX.fillStyle="#fff"; CTX.fillRect(x,y,w,h);
    CTX.restore();
    return;
  }
  CTX.restore();
}

function draw(){
  CTX.setTransform(1,0,0,1,0,0);
  CTX.fillStyle="#fff"; CTX.fillRect(0,0,W,H);
  const ox = (W - WORLD.size*SCALE)/2;
  const oy = (H - WORLD.size*SCALE)/2;

  // границы плиток
  CTX.lineWidth = Math.max(1, 0.8*DPR);
  CTX.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--outline').trim() || '#cfd6e3';

  // сначала рисунок/фото, затем границы
  for (const t of tiles){
    const x = Math.floor(ox + t.x*SCALE);
    const y = Math.floor(oy + t.y*SCALE);
    const w = Math.ceil(t.w*SCALE);
    const h = Math.ceil(t.h*SCALE);
    const claim = claims[t.id];
    if (claim){ pending = pending.then(()=>drawCover(claim.img, claim.name, x,y,w,h)); }
  }
  // рамки
  for (const t of tiles){
    const x = Math.floor(ox + t.x*SCALE);
    const y = Math.floor(oy + t.y*SCALE);
    const w = Math.ceil(t.w*SCALE);
    const h = Math.ceil(t.h*SCALE);
    CTX.strokeRect(x+0.5,y+0.5,w-1,h-1);
  }
  // hover-подсветка
  if (hoverId!=null){
    const t = tiles.find(z=>z.id===hoverId);
    if (t){
      const x = Math.floor(ox + t.x*SCALE);
      const y = Math.floor(oy + t.y*SCALE);
      const w = Math.ceil(t.w*SCALE);
      const h = Math.ceil(t.h*SCALE);
      CTX.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--hover') || 'rgba(0,0,0,.08)';
      CTX.fillRect(x,y,w,h);
    }
  }
}

let pending = Promise.resolve();

/* =================== HIT TEST + HOVER =================== */
function pickTile(px,py){
  const rect = CAN.getBoundingClientRect();
  const sx = (px-rect.left)*DPR, sy=(py-rect.top)*DPR;
  const ox = (W - WORLD.size*SCALE)/2;
  const oy = (H - WORLD.size*SCALE)/2;
  const wx = (sx - ox)/SCALE, wy=(sy - oy)/SCALE;
  if (wx<0||wy<0||wx>WORLD.size||wy>WORLD.size) return null;
  for (let i=tiles.length-1;i>=0;i--){
    const t=tiles[i];
    if (wx>=t.x && wy>=t.y && wx<=t.x+t.w && wy<=t.y+t.h) return t;
  }
  return null;
}

CAN.addEventListener('mousemove', e=>{
  const t = pickTile(e.clientX,e.clientY);
  const id = t ? t.id : null;
  if (id!==hoverId){ hoverId=id; draw(); }
  CAN.style.cursor = t ? 'pointer' : 'default';
});
CAN.addEventListener('mouseleave', ()=>{ hoverId=null; draw(); });

CAN.addEventListener('click', e=>{
  const t = pickTile(e.clientX,e.clientY); if(!t) return;
  const claim = claims[t.id];
  if (claim) openView(claim); else openAdd(t);
});

/* =================== ZOOM (без сдвига) =================== */
document.getElementById('stage').addEventListener('wheel', e=>{
  e.preventDefault();
  const factor = e.deltaY<0 ? 1.12 : 1/1.12;
  setZoom(factor);
},{passive:false});

window.addEventListener('keydown', e=>{
  if (e.key==='+' || e.key==='=' ) setZoom(1.12);
  if (e.key==='-' || e.key==='_') setZoom(1/1.12);
});

/* =================== MODALS =================== */
const viewOverlay = document.getElementById('viewOverlay');
const viewImg = document.getElementById('viewImg');
const viewTitle = document.getElementById('viewTitle');
const viewSub = document.getElementById('viewSub');
document.getElementById('viewClose').onclick = ()=> viewOverlay.classList.remove('on');
viewOverlay.addEventListener('click',e=>{ if(e.target===viewOverlay) viewOverlay.classList.remove('on'); });

const addOverlay = document.getElementById('addOverlay');
const addCancel  = document.getElementById('addCancel');
const addSave    = document.getElementById('addSave');
const drop       = document.getElementById('drop');
const file       = document.getElementById('file');
const preview    = document.getElementById('preview');
const dropText   = document.getElementById('dropText');
const desc       = document.getElementById('desc');
let addRect = null;

function openView(rec){
  viewTitle.textContent = rec.name || "Member of the Golden Million";
  viewSub.textContent = rec.desc || "“A short line for history.”";
  viewImg.src = rec.img;
  viewOverlay.classList.add('on');
}
function openAdd(t){
  addRect = t;
  preview.style.display='none'; preview.src=''; dropText.textContent='Drop an image here (or click)'; desc.value='';
  addOverlay.classList.add('on');
}

drop.addEventListener('click', ()=> file.click());
drop.addEventListener('dragover',e=>{ e.preventDefault(); drop.style.borderColor="#999"; });
drop.addEventListener('dragleave',()=>{ drop.style.borderColor="#cfd3da"; });
drop.addEventListener('drop',e=>{
  e.preventDefault(); drop.style.borderColor="#cfd3da";
  if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
file.addEventListener('change',e=>{ if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]); });

function handleFile(f){
  if(!/^image\//.test(f.type)) return alert("Please choose an image");
  const r=new FileReader(); r.onload=()=>{ preview.src=r.result; preview.style.display='block'; dropText.textContent='Image selected'; }; r.readAsDataURL(f);
}

addCancel.onclick = ()=> addOverlay.classList.remove('on');
addOverlay.addEventListener('click',e=>{ if(e.target===addOverlay) addOverlay.classList.remove('on'); });

addSave.onclick = async ()=>{
  if (!addRect) return;
  if (!preview.src) return alert("Please add an image first.");
  // сжимаем под короткую сторону плитки
  const shortSide = Math.min(addRect.w, addRect.h);
  const img = await downscaleToWebP(preview.src, Math.max(240, Math.round(shortSide*0.9)));
  claims[addRect.id] = { img, name:"Golden Million Member", desc:(desc.value||"I was here.").slice(0,80) };
  persist();
  addOverlay.classList.remove('on');
  draw();
};

/* ========= Utils: compress to WebP (quota-safe) ========= */
function loadImgBlob(src){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; }); }
async function downscaleToWebP(dataURL, targetShort){
  const im = await loadImgBlob(dataURL);
  const short = Math.min(im.width, im.height);
  const scale = Math.min(1, targetShort/short);
  const w = Math.max(180, Math.round(im.width*scale));
  const h = Math.max(180, Math.round(im.height*scale));
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const g = c.getContext('2d'); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';
  g.drawImage(im, 0,0,w,h);
  let out = c.toDataURL('image/webp', 0.86);
  if (out.length > 4_500_000) out = c.toDataURL('image/jpeg', 0.86);
  return out;
}

/* =================== BOOT =================== */
resize(); // first draw
</script>
</body>
</html>
