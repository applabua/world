<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>–î–û–®–ö–ê ‚Ññ1 –û–ì–û–õ–û–®–ï–ù–¨ ‚Ä¢ –£–∫—Ä–∞—ó–Ω–∞ ‚Äî 199 –≥—Ä–Ω/–º—ñ—Å –∑–∞ —Å–ª–æ—Ç</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#fff; --ink:#111; --muted:#6b7280; --line:#e7ebf2; --outline:#cfd6e3;
    --overlay:rgba(0,0,0,.5); --hover:rgba(0,0,0,.08); --primary:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:fixed;inset:0 0 auto 0;z-index:20;display:flex;justify-content:center;pointer-events:none}
  .bar{pointer-events:auto;display:flex;align-items:center;gap:12px;margin:10px auto;padding:8px 14px;border:1px solid var(--line);background:rgba(255,255,255,.96);border-radius:999px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
  .badge{font-weight:800}
  .muted{color:var(--muted)}
  .visits{position:fixed;right:10px;top:10px;z-index:25;background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:10px;padding:6px 10px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  .visits b{font-variant-numeric:tabular-nums}
  #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{display:block;max-width:100vw;max-height:100vh;width:100%;height:100%}

  /* Modals */
  .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.on{display:flex}
  .card{width:min(760px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:16px;animation:pop .22s ease-out both}
  @keyframes pop{from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1}}
  .title{margin:0 0 6px 0;font-weight:800}
  .sub{margin:0 0 12px 0;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .drop{min-height:160px;border:1px dashed #cfd3da;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#666;background:#fafafa;cursor:pointer}
  .thumb{max-width:100%;max-height:340px;border-radius:12px;border:1px solid var(--line);display:block}
  .input,.phone{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{border-color:var(--primary);background:var(--primary);color:#fff}
  .price{font-weight:700}
  .nav{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .nav .arrow{cursor:pointer;font-size:18px;padding:4px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .views{font-size:13px;color:#444}
</style>
</head>
<body>
<header>
  <div class="bar">
    <span class="badge">–î–û–®–ö–ê ‚Ññ1 –û–ì–û–õ–û–®–ï–ù–¨ ‚Ä¢ –£–∫—Ä–∞—ó–Ω–∞</span>
    <span class="muted">–ö—É–ø—É–π —Å–≤—ñ–π —Å–ª–æ—Ç –∑–∞ <b>199 –≥—Ä–Ω/–º—ñ—Å</b>. –î–æ–¥–∞–π —Ñ–æ—Ç–æ, –æ–ø–∏—Å —ñ —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî —ñ —Ç–µ–±–µ –ø–æ–±–∞—á–∞—Ç—å!</span>
  </div>
</header>
<div class="visits">–í—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ: <b id="visCounter">10369</b></div>

<div id="stage"><canvas id="wall"></canvas></div>

<!-- –ü–µ—Ä–µ–≥–ª—è–¥ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è -->
<div class="overlay" id="viewOverlay">
  <div class="card">
    <h3 class="title" id="vTitle">–û–≥–æ–ª–æ—à–µ–Ω–Ω—è</h3>
    <p class="sub" id="vSub"></p>
    <img id="vImg" class="thumb" alt="">
    <p class="views">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥—ñ–≤: <b id="vViews">0</b> &nbsp;‚Ä¢&nbsp; üìû <span id="vPhone"></span></p>
    <div class="nav">
      <button class="arrow" id="prevAd">‚óÄ –ü–æ–ø–µ—Ä–µ–¥–Ω—î</button>
      <button class="arrow" id="nextAd">–ù–∞—Å—Ç—É–ø–Ω–µ ‚ñ∂</button>
    </div>
    <div class="actions"><button class="btn" id="vClose">–ó–∞–∫—Ä–∏—Ç–∏</button></div>
  </div>
</div>

<!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è -->
<div class="overlay" id="addOverlay">
  <div class="card">
    <h3 class="title">–ü—Ä–∏–¥–±–∞—Ç–∏ —Å–ª–æ—Ç ‚Äî <span class="price">199 –≥—Ä–Ω/–º—ñ—Å</span> (–¥–µ–º–æ, –±–µ–∑ –æ–ø–ª–∞—Ç–∏)</h3>
    <p class="sub">–û–±—Ä–∞–Ω–∏–π –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫ —Å—Ç–∞–Ω–µ –≤–∞—à–∏–º –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º. –î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ, –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —ñ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.</p>
    <div class="row">
      <div class="col">
        <div class="drop" id="drop">
          <input type="file" id="file" accept="image/*" style="display:none">
          <span id="dropText">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–æ—Ç–æ —Å—é–¥–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å</span>
        </div>
        <img id="preview" class="thumb" alt="" style="display:none;margin-top:8px">
      </div>
      <div class="col">
        <input class="input" id="title" maxlength="60" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: iPhone 12, 128 –ì–ë)">
        <textarea class="input" id="desc" maxlength="160" rows="5" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å (–¥–æ 160 —Å–∏–º–≤–æ–ª—ñ–≤)"></textarea>
        <input class="phone" id="phone" maxlength="20" placeholder="+380 XX XXX XX XX">
        <p class="sub">* –û–±–º–µ–∂–µ–Ω–Ω—è –≤—ñ–¥ —Å–ø–∞–º—É: –Ω–µ –±—ñ–ª—å—à–µ <b>4</b> —Å—É—Å—ñ–¥–Ω—ñ—Ö —Å–ª–æ—Ç—ñ–≤, –∫—É–ø–ª–µ–Ω–∏—Ö –æ–¥–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º.</p>
      </div>
    </div>
    <div class="actions"><button class="btn" id="aCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn primary" id="aSave">–ó–±–µ—Ä–µ–≥—Ç–∏ (–¥–µ–º–æ)</button></div>
  </div>
</div>

<script>
/* ================== –ë–ê–ó–û–í–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ================== */
const CAN = document.getElementById('wall');
const CTX = CAN.getContext('2d', {alpha:false});
let DPR = Math.max(1, window.devicePixelRatio || 1);

/* ¬´–°—Ç—ñ–Ω–∞¬ª: –ª–æ–≥—ñ—á–Ω–∏–π –∫–≤–∞–¥—Ä–∞—Ç 1000√ó1000 (–º—ñ–ª—å–π–æ–Ω –º—ñ—Å—Ü—å).
   –ú–∏ –≤–∫—Ä–∏–≤–∞—î–º–æ —ó—ó 2000 –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–º–∏ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞–º–∏-—Å–ª–æ—Ç–∞–º–∏. */
const WORLD = { size: 1000 };
const SLOTS = 2000;
const PREFILL = 300;               // –∑–∞–ø–æ–≤–Ω—é—î–º–æ 300 —Ñ–µ–π–∫–æ–≤–∏—Ö
const PRICE_UA = 199;              // –≥—Ä–Ω/–º—ñ—Å
const LS_CLAIMS = 'ua_board_claims_v1';
const LS_VIS = 'ua_board_visitors_v1';
const OWNER_KEY = 'ua_board_owner_id';
/* –í–ª–∞—Å–Ω–∏–∫ (–∞–Ω–æ–Ω—ñ–º–Ω–∏–π ID —É —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ) */
let OWNER_ID = localStorage.getItem(OWNER_KEY);
if (!OWNER_ID){ OWNER_ID = 'u'+Math.random().toString(36).slice(2); localStorage.setItem(OWNER_KEY, OWNER_ID); }

/* ================== –£–¢–ò–õ–Ü–¢–ò –¢–ê RNG ================== */
let SEED = 424242>>>0;
function srand(){ SEED = (SEED*1664525 + 1013904223)>>>0; return SEED/4294967296; }
function rint(a,b){ return Math.floor(a + srand()*(b-a+1)); }
const rect = (x,y,w,h)=>({id:0,x,y,w,h,area:w*h});
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

/* ================== –ì–ï–ù–ï–†–ê–¶–Ü–Ø –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–á –ú–û–ó–ê–á–ö–ò ==================
   –†–æ–±–∏–º–æ —Ä—è–¥–∫–∏ –∑–º—ñ–Ω–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ (18..45), –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ —Ä—ñ–∂–µ–º–æ –Ω–∞
   –ø–ª–∏—Ç–∫–∏ –∑–º—ñ–Ω–Ω–æ—ó —à–∏—Ä–∏–Ω–∏ (30..140) —Ç–∞–∫, –∞–±–∏ –∫–æ–∂–Ω–∞ –±—É–ª–∞ —à–∏—Ä—à–∞ –∑–∞ –≤–∏—Å–æ—Ç—É. */
function buildHorizontalMosaic(target){
  const L = [];
  let y = 0;
  while (y < WORLD.size){
    const rowH = clamp(rint(18,45), 18, WORLD.size-y);
    let x = 0;
    while (x < WORLD.size){
      const maxW = Math.min(WORLD.size-x, rint(40,140));
      const minW = Math.max(rowH*1.2|0, 30);
      const w = clamp(rint(minW, Math.max(minW, maxW)), minW, WORLD.size-x);
      L.push(rect(x,y,w,rowH));
      x += w;
    }
    y += rowH;
  }
  // –Ø–∫—â–æ —Å–ª–æ—Ç—ñ–≤ –º–µ–Ω—à–µ –Ω—ñ–∂ —Ç—Ä–µ–±–∞ ‚Äî –¥—ñ–ª–∏–º–æ –¥–æ–≤–≥—ñ –ø–ª–∏—Ç–∫–∏ –Ω–∞–≤–ø—ñ–ª –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ.
  while (L.length < target){
    let idx = L.findIndex(r=>r.w>70);
    if (idx===-1) break;
    const r = L.splice(idx,1)[0];
    const cut = Math.max(30, Math.floor(r.w/2));
    L.push(rect(r.x,r.y,cut,r.h), rect(r.x+cut,r.y,r.w-cut,r.h));
  }
  // –Ø–∫—â–æ –±—ñ–ª—å—à–µ ‚Äî –æ–±—Ä—ñ–∑–∞—î–º–æ ¬´—Ö–≤—ñ—Å—Ç¬ª.
  L.length = Math.min(L.length, target);
  L.forEach((r,i)=>{ r.id=i; r.area=r.w*r.h; });
  return L;
}
let layout = buildHorizontalMosaic(SLOTS);

/* –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—ñ —Å—É—Å—ñ–¥—Å—Ç–≤–∞ (–ø–æ —Å–ø—ñ–ª—å–Ω—ñ–π —Å—Ç–æ—Ä–æ–Ω—ñ) –¥–ª—è –∞–Ω—Ç–∏-—Å–ø–∞–º—É */
const adj = new Map();
(function buildAdj(){
  for (const r of layout) adj.set(r.id, []);
  const byRow = [...layout].sort((a,b)=>a.y-b.y);
  for (let i=0;i<byRow.length;i++){
    const a = byRow[i];
    for (let j=i+1;j<byRow.length;j++){
      const b = byRow[j];
      if (b.y > a.y + a.h + 1) break; // –¥–∞–ª—ñ –Ω–µ–º–∞—î –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É
      // —Å–ø—ñ–ª—å–Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –º–µ–∂–∞?
      const shareH = (Math.abs((a.y+a.h) - b.y) <= 1) || (Math.abs((b.y+b.h) - a.y) <= 1);
      const overlapX = Math.max(0, Math.min(a.x+a.w, b.x+b.w) - Math.max(a.x, b.x));
      if (shareH && overlapX > 0){
        adj.get(a.id).push(b.id); adj.get(b.id).push(a.id);
      }
      // —Å–ø—ñ–ª—å–Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞ –º–µ–∂–∞?
      const shareV = (Math.abs((a.x+a.w) - b.x) <= 1) || (Math.abs((b.x+b.w) - a.x) <= 1);
      const overlapY = Math.max(0, Math.min(a.y+a.h, b.y+b.h) - Math.max(a.y, b.y));
      if (shareV && overlapY > 0){
        adj.get(a.id).push(b.id); adj.get(b.id).push(a.id);
      }
    }
  }
})();

/* ================== –î–ê–ù–Ü –¢–ê –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø ================== */
let claims = {};
try{ claims = JSON.parse(localStorage.getItem(LS_CLAIMS) || "{}"); }catch(_){ claims = {}; }
function saveClaims(){ try{ localStorage.setItem(LS_CLAIMS, JSON.stringify(claims)); }catch(e){ alert('–ü–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–æ —Å—Ö–æ–≤–∏—â–µ. –°–ø—Ä–æ–±—É–π—Ç–µ –º–µ–Ω—à–µ —Ñ–æ—Ç–æ.'); }}

/* ================== –ü–ï–†–ï–î–ó–ê–ü–û–í–ù–ï–ù–Ü 300 –û–ì–û–õ–û–®–ï–ù–¨ ================== */
const NAMES = ["iPhone 12","–î–∏–≤–∞–Ω –∫—É—Ç–æ–≤–∏–π","–ù–æ—É—Ç–±—É–∫ Lenovo","–í–µ–ª–æ—Å–∏–ø–µ–¥ Trek","–ö–∞–≤–æ–≤–∞—Ä–∫–∞ DeLonghi","–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫","–ö–æ–º–æ–¥ IKEA","–°—Ç–æ–ª–∏–∫ –∂—É—Ä–Ω–∞–ª—å–Ω–∏–π","–ö—Ä—ñ—Å–ª–æ –æ—Ñ—ñ—Å–Ω–µ","–¢–µ–ª–µ–≤—ñ–∑–æ—Ä Samsung","–®–∏–Ω–∏ –∑–∏–º–æ–≤—ñ","–ü—Ä–∞–ª—å–Ω–∞ –º–∞—à–∏–Ω–∞","–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫","PlayStation 5","–ö–≤–∞—Ä—Ç–∏—Ä–∞ 1–∫, –õ—å–≤—ñ–≤","–ö–≤–∞—Ä—Ç–∏—Ä–∞ 2–∫, –ö–∏—ó–≤","–ë—É–¥–∏–Ω–æ–∫ –ø—ñ–¥ –ö–∏—î–≤–æ–º","–û—Ä–µ–Ω–¥–∞ –≥–∞—Ä–∞–∂–∞","–û—Ä–µ–Ω–¥–∞ –æ—Ñ—ñ—Å—É","–ê–≤—Ç–æ–º–æ–±—ñ–ª—å Skoda","–ê–≤—Ç–æ–º–æ–±—ñ–ª—å BMW","–ï–ª–µ–∫—Ç—Ä–æ—Å–∞–º–æ–∫–∞—Ç","–ï–ª–µ–∫—Ç—Ä–æ—Å–∫—É—Ç–µ—Ä","–ì—ñ—Ç–∞—Ä–∞ Fender","–ü—ñ–∞–Ω—ñ–Ω–æ","–î–∏—Ç—è—á–∞ –∫–æ–ª—è—Å–∫–∞","–õ—ñ–∂–∫–æ –¥–≤–æ—Å–ø–∞–ª—å–Ω–µ","–ú–∞—Ç—Ä–∞—Ü –æ—Ä—Ç–æ–ø–µ–¥–∏—á–Ω–∏–π","–°–º–∞—Ä—Ç—Ñ–æ–Ω Samsung","–ù–∞–≤—É—à–Ω–∏–∫–∏ AirPods","–ú–æ–Ω—ñ—Ç–æ—Ä 27\"","–í—ñ–¥–µ–æ–∫–∞—Ä—Ç–∞ RTX","–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä","–§–µ–Ω Dyson","–§–æ—Ç–æ–∞–ø–∞—Ä–∞—Ç Canon","–û–±—ñ–≥—Ä—ñ–≤–∞—á","–ö–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä","–ë–æ–π–ª–µ—Ä","–ì–∞–∑–æ–Ω–æ–∫–æ—Å–∞—Ä–∫–∞","–°–Ω—ñ–≥–æ–ø—Ä–∏–±–∏—Ä–∞—á","–ü–æ—Å—É–¥–æ–º–∏–π–∫–∞","–°–∞–¥–æ–≤—ñ –º–µ–±–ª—ñ","–ë–∞—Ç—É—Ç –¥–∏—Ç—è—á–∏–π","–î–µ—Ä–µ–≤ º—è–Ω–∏–π –±—É–¥–∏–Ω–æ–∫","–ü–ª–∏—Ç–∫–∞ –∫–µ—Ä–∞–º—ñ—á–Ω–∞","–õ–∞–º—ñ–Ω–∞—Ç","–î–≤–µ—Ä—ñ –≤—Ö—ñ–¥–Ω—ñ","–í—ñ–∫–Ω–∞ –º–µ—Ç–∞–ª–æ–ø–ª–∞—Å—Ç–∏–∫–æ–≤—ñ","–°–µ—Ä–≤—ñ—Å –≤–∞–Ω—Ç–∞–∂—ñ–≤","–†–µ–º–æ–Ω—Ç —Ç–µ—Ö–Ω—ñ–∫–∏","–†–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä","–ö–ª—ñ–Ω—ñ–Ω–≥","–î–æ—Å—Ç–∞–≤–∫–∞ –≤–æ–¥–∏","–†–µ–ø–µ—Ç–∏—Ç–æ—Ä –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—ó","–ù—è–Ω—è","–§–æ—Ç–æ–≥—Ä–∞—Ñ","–í—ñ–¥–µ–æ–≥—Ä–∞—Ñ","SMM –ø–æ—Å–ª—É–≥–∏","–†–æ–∑—Ä–æ–±–∫–∞ —Å–∞–π—Ç—ñ–≤","SEO","–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥","–ö–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä","–£—Ä–æ–∫–∏ –≥—Ä–∏ –Ω–∞ –≥—ñ—Ç–∞—Ä—ñ"];
function randPhone(){ const p = '0'+rint(50,99)+' '+rint(100,999)+' '+rint(10,99)+' '+rint(10,99); return '+380 '+p; }
function prefillFake(){
  // —è–∫—â–æ –≤–∂–µ —î ‚â•300 ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
  const had = Object.values(claims).filter(x=>x && x.demo).length;
  if (had >= PREFILL) return;
  // –í–∏–±–∏—Ä–∞—î–º–æ 300 –Ω–∞–π–±—ñ–ª—å—à–∏—Ö —Å–ª–æ—Ç—ñ–≤ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ
  const slots = [...layout].sort((a,b)=>b.area-a.area).slice(0, PREFILL);
  slots.forEach((r,i)=>{
    const name = NAMES[i % NAMES.length] + (i%7===0 ? ' ‚Ä¢ —è–∫ –Ω–æ–≤–∏–π' : '');
    const desc = (['–°—Ç–∞–Ω: –≤—ñ–¥–º—ñ–Ω–Ω–∏–π.','–ì–∞—Ä–∞–Ω—Ç—ñ—è 6 –º—ñ—Å.','–ú–æ–∂–ª–∏–≤–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –ù–æ–≤–æ—é –ü–æ—à—Ç–æ—é.','–°–∞–º–æ–≤–∏–≤—ñ–∑ —Å—å–æ–≥–æ–¥–Ω—ñ.','–¢–æ—Ä–≥ –¥–æ—Ä–µ—á–Ω–∏–π.','–ë–µ–∑ –ø–æ—Å–µ—Ä–µ–¥–Ω–∏–∫—ñ–≤.'])[i%6];
    const phone = randPhone();
    const url = `https://picsum.photos/seed/ua${r.id}/800/500`;
    claims[r.id] = { img:url, title:name, desc, phone, views:rint(1000,90000), owner:'demo', demo:true };
  });
  saveClaims();
}
prefillFake();

/* ============== –í–Ü–î–í–Ü–î–£–í–ê–ß–Ü (–ø—Ä–∞–≤–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –∫—É—Ç) ============== */
const visEl = document.getElementById('visCounter');
let visitors = Number(localStorage.getItem(LS_VIS) || 10369);
visEl.textContent = visitors.toLocaleString('uk-UA');
function tickVisitors(){
  const add = [1,1,2,2,3,4][rint(0,5)];
  visitors += add;
  visEl.textContent = visitors.toLocaleString('uk-UA');
  localStorage.setItem(LS_VIS, String(visitors));
  setTimeout(tickVisitors, rint(900,2200));
}
setTimeout(tickVisitors, 1200);

/* –Ü–Ω–∫–æ–ª–∏ –∑–±—ñ–ª—å—à—É—î–º–æ –ø–µ—Ä–µ–≥–ª—è–¥–∏ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º —É–∂–µ —ñ—Å–Ω—É—é—á–∏–º –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º */
setInterval(()=>{
  const ids = Object.keys(claims);
  if (!ids.length) return;
  const id = ids[rint(0,ids.length-1)];
  if (claims[id]){ claims[id].views = (claims[id].views||0)+1; saveClaims(); draw(); }
}, 2500);

/* ================== –†–ï–ù–î–ï–† –ö–ê–ù–í–ê–° ================== */
let W=0,H=0,SCALE=1, hoverId=null;
function resize(){
  const vw = Math.max(360, window.innerWidth);
  const vh = Math.max(360, window.innerHeight);
  W = Math.floor(vw*DPR); H = Math.floor(vh*DPR);
  CAN.width = W; CAN.height = H; CAN.style.width = vw+'px'; CAN.style.height = vh+'px';
  fitToView(); draw();
}
function fitToView(){ SCALE = Math.min(W, H) / WORLD.size; }
window.addEventListener('resize', resize);

const imgCache = new Map();
function loadImg(src){
  if (imgCache.has(src)) return imgCache.get(src);
  const p = new Promise((res,rej)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.referrerPolicy='no-referrer'; im.onload=()=>res(im); im.onerror=rej; im.src=src; });
  imgCache.set(src,p); return p;
}

async function drawCover(src, x,y,w,h){
  CTX.save();
  CTX.beginPath(); CTX.rect(x,y,w,h); CTX.clip();
  try{
    const im = await loadImg(src);
    const r = Math.max(w/im.width, h/im.height);
    const iw = im.width*r, ih = im.height*r;
    const ix = x + (w - iw)/2, iy = y + (h - ih)/2;
    CTX.fillStyle="#fff"; CTX.fillRect(x,y,w,h);
    CTX.drawImage(im, ix, iy, iw, ih);
  }catch(_){
    CTX.fillStyle="#f2f2f2"; CTX.fillRect(x,y,w,h);
  }
  CTX.restore();
}

let drawQueue = Promise.resolve();
function q(p){ drawQueue = drawQueue.then(()=>p).catch(()=>{}); }

function draw(){
  CTX.setTransform(1,0,0,1,0,0);
  CTX.fillStyle="#fff"; CTX.fillRect(0,0,W,H);
  const ox = (W - WORLD.size*SCALE)/2;
  const oy = (H - WORLD.size*SCALE)/2;

  // –°–ø–æ—á–∞—Ç–∫—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω—å
  for (const r of layout){
    const x = Math.floor(ox + r.x*SCALE);
    const y = Math.floor(oy + r.y*SCALE);
    const w = Math.ceil(r.w*SCALE);
    const h = Math.ceil(r.h*SCALE);
    const ad = claims[r.id];
    if (ad){ q(drawCover(ad.img, x,y,w,h)); }
  }
  // –†–∞–º–∫–∏
  CTX.lineWidth = Math.max(1, 0.8*DPR);
  CTX.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--outline').trim() || '#cfd6e3';
  for (const r of layout){
    const x = Math.floor(ox + r.x*SCALE);
    const y = Math.floor(oy + r.y*SCALE);
    const w = Math.ceil(r.w*SCALE);
    const h = Math.ceil(r.h*SCALE);
    CTX.strokeRect(x+0.5,y+0.5,w-1,h-1);
  }
  // –ù–∞–∫–ª–∞–¥–∫–∏: –ø–µ—Ä–µ–≥–ª—è–¥–∏ (–¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö)
  CTX.font = `${12*DPR}px system-ui,Arial`; CTX.fillStyle="rgba(0,0,0,.55)"; CTX.textBaseline="middle";
  for (const r of layout){
    const ad = claims[r.id]; if (!ad) continue;
    const x = Math.floor(ox + r.x*SCALE), y = Math.floor(oy + r.y*SCALE), w = Math.ceil(r.w*SCALE), h = Math.ceil(r.h*SCALE);
    const pad = 6*DPR; const txt = `üëÅ ${ (ad.views||0).toLocaleString('uk-UA') }`;
    const tw = CTX.measureText(txt).width;
    CTX.fillStyle="rgba(255,255,255,.8)"; CTX.fillRect(x+pad,y+h-22*DPR, tw+12*DPR, 18*DPR);
    CTX.fillStyle="#222"; CTX.fillText(txt, x+pad+6*DPR, y+h-13*DPR);
  }
  // Hover-–ø—ñ–¥—Å–≤—ñ—Ç–∫–∞
  if (hoverId!=null){
    const r = layout[hoverId];
    const x = Math.floor(ox + r.x*SCALE), y = Math.floor(oy + r.y*SCALE), w = Math.ceil(r.w*SCALE), h = Math.ceil(r.h*SCALE);
    CTX.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--hover') || 'rgba(0,0,0,.08)';
    CTX.fillRect(x,y,w,h);
  }
}

/* ================== HIT-TEST, HOVER, –ö–õ–Ü–ö ================== */
function pick(px,py){
  const rect = CAN.getBoundingClientRect();
  const sx = (px-rect.left)*DPR, sy=(py-rect.top)*DPR;
  const ox = (W - WORLD.size*SCALE)/2;
  const oy = (H - WORLD.size*SCALE)/2;
  const wx = (sx - ox)/SCALE, wy = (sy - oy)/SCALE;
  if (wx<0||wy<0||wx>WORLD.size||wy>WORLD.size) return null;
  for (let i=layout.length-1;i>=0;i--){
    const r=layout[i];
    if (wx>=r.x && wy>=r.y && wx<=r.x+r.w && wy<=r.y+r.h) return r;
  }
  return null;
}
CAN.addEventListener('mousemove', e=>{
  const r = pick(e.clientX,e.clientY);
  hoverId = r ? r.id : null;
  CAN.style.cursor = r ? 'pointer' : 'default';
  draw();
});
CAN.addEventListener('mouseleave', ()=>{ hoverId=null; draw(); });

/* ================== –í–Ü–î–ö–†–ò–í–ê–Ñ–ú–û / –î–û–î–ê–Ñ–ú–û –û–ì–û–õ–û–®–ï–ù–ù–Ø ================== */
const viewOverlay = document.getElementById('viewOverlay');
const vTitle = document.getElementById('vTitle');
const vSub   = document.getElementById('vSub');
const vImg   = document.getElementById('vImg');
const vViews = document.getElementById('vViews');
const vPhone = document.getElementById('vPhone');
document.getElementById('vClose').onclick = ()=> viewOverlay.classList.remove('on');
viewOverlay.addEventListener('click', e=>{ if(e.target===viewOverlay) viewOverlay.classList.remove('on'); });

let currentViewIndex = 0; // —ñ–Ω–¥–µ–∫—Å —É –º–∞—Å–∏–≤—ñ filledIds
function filledIds(){ return Object.keys(claims).map(n=>+n).sort((a,b)=>a-b); }
function openViewByIndex(idx){
  const ids = filledIds(); if (!ids.length) return;
  currentViewIndex = (idx+ids.length)%ids.length;
  const id = ids[currentViewIndex], ad = claims[id];
  vTitle.textContent = ad.title || '–û–≥–æ–ª–æ—à–µ–Ω–Ω—è';
  vSub.textContent   = ad.desc  || '';
  vImg.src           = ad.img;
  vViews.textContent = (ad.views||0).toLocaleString('uk-UA');
  vPhone.textContent = ad.phone || '';
  viewOverlay.classList.add('on');
  // +1 –ø–µ—Ä–µ–≥–ª—è–¥
  ad.views = (ad.views||0)+1; saveClaims(); draw();
}
document.getElementById('prevAd').onclick = ()=> openViewByIndex(currentViewIndex-1);
document.getElementById('nextAd').onclick = ()=> openViewByIndex(currentViewIndex+1);

CAN.addEventListener('click', e=>{
  const r = pick(e.clientX,e.clientY); if (!r) return;
  const ad = claims[r.id];
  if (ad){ // –ø–µ—Ä–µ–≥–ª—è–¥
    const ids = filledIds(); currentViewIndex = Math.max(0, ids.indexOf(r.id));
    openViewByIndex(currentViewIndex);
  } else { // –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    pendingRect = r; openAdd();
  }
});

/* ================== –ê–ù–¢–ò-–°–ü–ê–ú: –Ω–µ –±—ñ–ª—å—à–µ 4 —Å—É–º—ñ–∂–Ω–∏—Ö ================== */
function clusterSizeIfAdd(ownerId, rectId){
  // DFS –ø–æ —Å—É—Å—ñ–¥–Ω—ñ—Ö –ø–ª–∏—Ç–∫–∞—Ö, –∑–∞–π–Ω—è—Ç–∏—Ö —Ü–∏–º –≤–ª–∞—Å–Ω–∏–∫–æ–º (–ø–ª—é—Å –ø–æ—Ç–æ—á–Ω–∞)
  const stack=[rectId], seen=new Set([rectId]);
  let size=0;
  while (stack.length){
    const id = stack.pop(); size++;
    const nbrs = adj.get(id) || [];
    for (const nb of nbrs){
      if (seen.has(nb)) continue;
      const claim = claims[nb];
      if (claim && claim.owner===ownerId){ seen.add(nb); stack.push(nb); }
    }
  }
  return size;
}

/* ================== –ú–û–î–ê–õ–ö–ê –î–û–î–ê–í–ê–ù–ù–Ø ================== */
const addOverlay = document.getElementById('addOverlay');
const aCancel = document.getElementById('aCancel');
const aSave   = document.getElementById('aSave');
const drop    = document.getElementById('drop');
const file    = document.getElementById('file');
const preview = document.getElementById('preview');
const dropText= document.getElementById('dropText');
const titleIn = document.getElementById('title');
const descIn  = document.getElementById('desc');
const phoneIn = document.getElementById('phone');

let pendingRect = null;

function openAdd(){
  preview.style.display='none'; preview.src=''; dropText.textContent='–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–æ—Ç–æ —Å—é–¥–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å';
  titleIn.value=''; descIn.value=''; phoneIn.value='';
  addOverlay.classList.add('on');
}
aCancel.onclick = ()=> addOverlay.classList.remove('on');
addOverlay.addEventListener('click', e=>{ if(e.target===addOverlay) addOverlay.classList.remove('on'); });

drop.addEventListener('click', ()=> file.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor="#999"; });
drop.addEventListener('dragleave', ()=>{ drop.style.borderColor="#cfd3da"; });
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.style.borderColor="#cfd3da";
  if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
file.addEventListener('change', e=>{ if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]); });

function handleFile(f){
  if(!/^image\//.test(f.type)) return alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.');
  const r=new FileReader();
  r.onload=()=>{ preview.src=r.result; preview.style.display='block'; dropText.textContent='–§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ'; };
  r.readAsDataURL(f);
}

aSave.onclick = async ()=>{
  if (!pendingRect) return;
  if (!preview.src) return alert('–î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è.');
  if (!titleIn.value.trim()) return alert('–í–∫–∞–∂—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫.');
  if (!phoneIn.value.trim()) return alert('–í–∫–∞–∂—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω.');

  // –∞–Ω—Ç–∏-—Å–ø–∞–º: —á–∏ –Ω–µ —Å—Ç–∞–Ω–µ –∫–ª–∞—Å—Ç–µ—Ä > 4
  const would = clusterSizeIfAdd(OWNER_ID, pendingRect.id);
  if (would > 4){ alert('–û–±–º–µ–∂–µ–Ω–Ω—è: –º–∞–∫—Å–∏–º—É–º 4 —Å—É—Å—ñ–¥–Ω—ñ —Å–ª–æ—Ç–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.'); return; }

  // —Å—Ç–∏—Å–∫–∞—î–º–æ –ø—ñ–¥ —Ä–æ–∑–º—ñ—Ä –ø–ª–∏—Ç–∫–∏
  const shortSide = Math.min(pendingRect.w, pendingRect.h);
  const img = await downscaleToWebP(preview.src, Math.max(260, Math.round(shortSide*0.9)));
  claims[pendingRect.id] = {
    img, title: titleIn.value.slice(0,60), desc: descIn.value.slice(0,160),
    phone: phoneIn.value.slice(0,20), views: rint(0,30), owner: OWNER_ID
  };
  saveClaims();
  addOverlay.classList.remove('on');
  draw();
};

/* –°—Ç–∏—Å–Ω–µ–Ω–Ω—è –¥–æ WebP */
function loadImgBlob(src){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; }); }
async function downscaleToWebP(dataURL, targetShort){
  const im = await loadImgBlob(dataURL);
  const short = Math.min(im.width, im.height);
  const scale = Math.min(1, targetShort/short);
  const w = Math.max(180, Math.round(im.width*scale));
  const h = Math.max(140, Math.round(im.height*scale));
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const g = c.getContext('2d'); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';
  g.drawImage(im, 0,0,w,h);
  let out = c.toDataURL('image/webp', 0.86);
  if (out.length > 4_500_000) out = c.toDataURL('image/jpeg', 0.86);
  return out;
}

/* ================== –ó–£–ú –ë–ï–ó –ü–ê–ù–û–†–ê–ú–ò ================== */
document.getElementById('stage').addEventListener('wheel', e=>{
  e.preventDefault();
  const factor = e.deltaY<0 ? 1.12 : 1/1.12;
  SCALE = clamp(SCALE*factor, 0.25, 3);
  draw();
},{passive:false});
window.addEventListener('keydown', e=>{
  if (e.key==='+' || e.key==='='){ SCALE = clamp(SCALE*1.12, 0.25, 3); draw(); }
  if (e.key==='-' || e.key==='_'){ SCALE = clamp(SCALE/1.12, 0.25, 3); draw(); }
});

/* ================== –°–¢–ê–†–¢ ================== */
resize(); // –ø–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä
</script>
</body>
</html>
