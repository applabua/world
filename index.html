<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GOLDEN MILLION — Get in now, be remembered beside legends.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{ --bg:#fff; --ink:#111; --muted:#6b7280; --line:#e4e7ee; --outline:#cfd6e3; --overlay:rgba(0,0,0,.5); }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:fixed;inset:0 0 auto 0;z-index:20;display:flex;justify-content:center;padding:8px 12px;pointer-events:none}
  .cta{pointer-events:auto;display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.96);border:1px solid #e7ebf2;border-radius:999px;padding:8px 14px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
  .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(#ffd24d,#e1b526)}
  .cta b{font-weight:800}.cta span{color:var(--muted)}
  #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{display:block; max-width:100vw; max-height:100vh; width:100%; height:100%}

  /* Modals */
  .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.on{display:flex}
  .card{width:min(720px,92vw);background:#fff;border:1px solid #e7ebf2;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:16px;animation:pop .22s ease-out both}
  @keyframes pop{from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1}}
  .title{margin:0 0 6px 0;font-weight:800}
  .sub{margin:0 0 12px 0;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .drop{min-height:160px;border:1px dashed #cfd3da;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#666;background:#fafafa;cursor:pointer}
  .thumb{max-width:100%;max-height:340px;border-radius:12px;border:1px solid #e7ebf2;display:block}
  .input{width:100%;padding:10px 12px;border:1px solid #e7ebf2;border-radius:10px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .btn{appearance:none;border:1px solid #e7ebf2;background:#fff;color:#111;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{border-color:#111;background:#111;color:#fff}
</style>
</head>
<body>
<header>
  <div class="cta"><div class="dot"></div><b>GOLDEN MILLION</b><span>Get in now — be remembered beside legends.</span></div>
</header>

<div id="stage"><canvas id="wall"></canvas></div>

<!-- VIEW -->
<div class="overlay" id="viewOverlay">
  <div class="card">
    <h3 class="title" id="viewTitle">Legend</h3>
    <p class="sub" id="viewSub">“A short line for history.”</p>
    <img id="viewImg" class="thumb" alt="">
    <div class="actions"><button class="btn" id="viewClose">Close</button></div>
  </div>
</div>

<!-- ADD -->
<div class="overlay" id="addOverlay">
  <div class="card">
    <h3 class="title">Claim your golden spot — $1 / year (test mode)</h3>
    <p class="sub">Add your image and a short line about yourself. Saved locally in your browser for now.</p>
    <div class="row">
      <div class="col">
        <div class="drop" id="drop"><input type="file" id="file" accept="image/*" style="display:none"><span id="dropText">Drop an image here (or click)</span></div>
        <img id="preview" class="thumb" alt="" style="display:none;margin-top:8px">
      </div>
      <div class="col">
        <label class="sub" for="desc">Your short line (max 80 chars)</label>
        <input class="input" id="desc" maxlength="80" placeholder="I was here. 2025.">
      </div>
    </div>
    <div class="actions"><button class="btn" id="addCancel">Cancel</button><button class="btn primary" id="addSave">Save (test)</button></div>
  </div>
</div>

<script>
/* ========================= Core ========================= */
const CAN = document.getElementById('wall');
const CTX = CAN.getContext('2d', {alpha:false});
let DPR = Math.max(1, window.devicePixelRatio || 1);

/* Logical million places: 1000×1000 cells (no background grid drawn). */
const WORLD = { cells:1000, size:1000 }; // square 1000×1000 «единиц»
/* We cover it by a mosaic of rectangles of different sizes. */
const TILE_COUNT = 3000;                 // достаточно разнообразно и быстро
const LEGENDS_COUNT = 100;               // топ-100 самых больших — под легенды

/* State */
let tiles = [];      // [{id,x,y,w,h, area}]
let claims = {};     // id -> {img, name, desc, legend}
const LS_KEY = 'gm_canvas_claims_v1';

/* ================== Utils & RNG (deterministic) ================== */
let SEED = 123456789>>>0;
function srand(){ SEED = (SEED*1664525 + 1013904223)>>>0; return SEED/4294967296; }
function rint(a,b){ return Math.floor(a + srand()*(b-a+1)); }
function rect(x,y,w,h){ return {id:0,x,y,w,h, area:w*h}; }
function splitOne(r){
  const horiz = r.w >= r.h;
  if (horiz){
    const min = Math.max(20, Math.floor(r.w*0.33));
    const max = Math.min(r.w-20, Math.floor(r.w*0.67));
    if (max<=min) return [r];
    const cut = rint(min,max);
    return [ rect(r.x, r.y, cut, r.h), rect(r.x+cut, r.y, r.w-cut, r.h) ];
  } else {
    const min = Math.max(20, Math.floor(r.h*0.33));
    const max = Math.min(r.h-20, Math.floor(r.h*0.67));
    if (max<=min) return [r];
    const cut = rint(min,max);
    return [ rect(r.x, r.y, r.w, cut), rect(r.x, r.y+cut, r.w, r.h-cut) ];
  }
}
function buildMosaic(target){
  const list = [ rect(0,0, WORLD.size, WORLD.size) ];
  while(list.length < target){
    let idx=-1, best=-1;
    for(let i=0;i<list.length;i++){
      const r=list[i]; if (r.w>40 && r.h>40 && r.area>best){ best=r.area; idx=i; }
    }
    if (idx===-1) break;
    const r=list.splice(idx,1)[0];
    const [a,b]=splitOne(r);
    if (b){ a.area=a.w*a.h; b.area=b.w*b.h; list.push(a,b); } else list.push(r);
  }
  // Correct too skinny
  for(let k=0;k<list.length;k++){
    const r=list[k], asp=r.w/r.h;
    if (asp>3 || asp<0.33){
      const p=splitOne(r);
      if (p.length===2){ list.splice(k,1,p[0],p[1]); k--; }
    }
  }
  while(list.length>target) list.pop();
  list.forEach((r,i)=> r.id=i);
  return list;
}

/* =================== Legends (100 biggest) =================== */
const LEGEND_PHOTOS = {
  "Napoleon Bonaparte":"https://upload.wikimedia.org/wikipedia/commons/5/50/Napoleon_Bonaparte_by_Jean-Auguste-Dominique_Ingres%2C_1806.jpg",
  "Donald Trump":"https://upload.wikimedia.org/wikipedia/commons/5/56/Donald_Trump_official_portrait.jpg",
  "Volodymyr Zelenskyy":"https://upload.wikimedia.org/wikipedia/commons/2/2e/Volodymyr_Zelensky_Official_portrait.jpg",
  "Elon Musk":"https://upload.wikimedia.org/wikipedia/commons/4/49/Elon_Musk_2015.jpg",
  "George Washington":"https://upload.wikimedia.org/wikipedia/commons/6/6f/George_Washington_by_Gilbert_Stuart%2C_1797.jpg",
  "Abraham Lincoln":"https://upload.wikimedia.org/wikipedia/commons/a/a4/Abraham_Lincoln_O-116_by_Gardner%2C_1865-crop.png",
  "Albert Einstein":"https://upload.wikimedia.org/wikipedia/commons/d/d3/Albert_Einstein_Head.jpg",
  "Leonardo da Vinci":"https://upload.wikimedia.org/wikipedia/commons/6/6d/Leonardo_self.jpg",
  "Marie Curie":"https://upload.wikimedia.org/wikipedia/commons/7/7e/Marie_Curie_c1920.jpg",
  "Nikola Tesla":"https://upload.wikimedia.org/wikipedia/commons/d/d4/N.Tesla.JPG",
  "Mahatma Gandhi":"https://upload.wikimedia.org/wikipedia/commons/d/d1/Portrait_Gandhi.jpg",
  "Martin Luther King Jr.":"https://upload.wikimedia.org/wikipedia/commons/a/a3/Martin_Luther_King_Jr_NYWTS_6.jpg",
  "Winston Churchill":"https://upload.wikimedia.org/wikipedia/commons/1/1e/Sir_Winston_Churchill_-_19086236948.jpg",
  "Cleopatra":"https://upload.wikimedia.org/wikipedia/commons/2/2b/Cleopatra_VII_%28Altes_Museum%29.jpg",
  "Steve Jobs":"https://upload.wikimedia.org/wikipedia/commons/8/80/Steve_Jobs_Headshot_2010-CROP2.jpg",
  "Bill Gates":"https://upload.wikimedia.org/wikipedia/commons/a/a0/Bill_Gates_2018.jpg",
  "Jeff Bezos":"https://upload.wikimedia.org/wikipedia/commons/3/35/Jeff_Bezos_cropped.jpg",
  "Barack Obama":"https://upload.wikimedia.org/wikipedia/commons/8/8d/President_Barack_Obama.jpg",
  "Joe Biden":"https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg",
  "Angela Merkel":"https://upload.wikimedia.org/wikipedia/commons/b/bb/Angela_Merkel_Juli_2010_-_3zu4.jpg"
};
const LEGEND_NAMES = Object.keys(LEGEND_PHOTOS).concat([
  "Nelson Mandela","Julius Caesar","Pablo Picasso","Vincent van Gogh","Michelangelo",
  "Ada Lovelace","Alan Turing","Grace Hopper","Katherine Johnson","Hedy Lamarr",
  "Charles Darwin","Carl Sagan","Johannes Kepler","Niels Bohr","William Shakespeare",
  "Homer","Dante Alighieri","Johann Sebastian Bach","Ludwig van Beethoven","Wolfgang Amadeus Mozart",
  "Leo Tolstoy","Fyodor Dostoevsky","Ernest Hemingway","Agatha Christie","Serena Williams",
  "Michael Jordan","Kobe Bryant","Lionel Messi","Cristiano Ronaldo","Pelé",
  "Usain Bolt","Bruce Lee","Jackie Chan","Hayao Miyazaki","Akira Kurosawa",
  "Steven Spielberg","George Lucas","Quentin Tarantino","James Cameron","Mother Teresa",
  "Florence Nightingale","Yayoi Kusama","Banksy","Salvador Dalí","Socrates",
  "Plato","Aristotle","Confucius","Sun Tzu","Genghis Khan",
  "Alexander the Great","Queen Elizabeth II","Joan of Arc","Catherine the Great","Sheryl Sandberg",
  "Satya Nadella","Sundar Pichai","Tim Cook","Susan Wojcicki","Desmond Tutu",
  "Lech Wałęsa","Václav Havel","Stephen Hawking","Jane Goodall","Neil Armstrong",
  "Yuri Gagarin","Amelia Earhart","J.R.R. Tolkien","George R. R. Martin","J.K. Rowling",
  "Haruki Murakami","Gabriel García Márquez","Oprah Winfrey","Greta Thunberg","Galileo Galilei"
]).slice(0,LEGENDS_COUNT);

function initialsAvatar(name,w,h){
  const init = name.split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase();
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
    <stop offset='0%' stop-color='#fff2b2'/><stop offset='100%' stop-color='#e4c45e'/>
  </linearGradient></defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
        font-family='system-ui,Arial' font-size='${Math.floor(Math.min(w,h)*0.35)}'
        font-weight='800' fill='#111'>${init}</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* ===================== Storage ===================== */
try{ claims = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }catch(e){ claims = {}; }
function persist(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(claims)); }catch(e){ alert("Storage quota exceeded. Try a smaller image."); }}

/* ===================== Build & Prefill ===================== */
tiles = buildMosaic(TILE_COUNT);
(function prefill(){
  const have = Object.values(claims).filter(v=>v && v.legend).length;
  if (have >= LEGENDS_COUNT) return;
  const sorted = [...tiles].sort((a,b)=>b.area-a.area).slice(0,LEGENDS_COUNT);
  sorted.forEach((t,i)=>{
    const name = LEGEND_NAMES[i] || "Legend";
    const url  = LEGEND_PHOTOS[name];
    claims[t.id] = {
      img: url || initialsAvatar(name, Math.max(300, t.w), Math.max(300, t.h)),
      name, desc:"Part of the Golden Million.", legend:true
    };
  });
  persist();
})();

/* ===================== Rendering ===================== */
let W=0,H=0, SCALE=1; // canvas pixel size & scale (cells->px)
function resize(){
  // fit whole wall inside viewport (fixed page)
  const vw = Math.max(320, window.innerWidth);
  const vh = Math.max(320, window.innerHeight);
  const k = Math.min(vw, vh) * DPR;
  // we keep aspect 1:1 for world (1000×1000)
  W = Math.floor(vw * DPR); H = Math.floor(vh * DPR);
  CAN.width = W; CAN.height = H;
  CAN.style.width = vw + 'px'; CAN.style.height = vh + 'px';
  SCALE = Math.min(W, H) / WORLD.size;
  draw();
}
window.addEventListener('resize', resize);

const imgCache = new Map();
function loadImg(src){
  if (imgCache.has(src)) return imgCache.get(src);
  const p = new Promise((res,rej)=>{ const im=new Image(); im.crossOrigin="anonymous"; im.referrerPolicy="no-referrer"; im.onload=()=>res(im); im.onerror=rej; im.src=src; });
  imgCache.set(src,p); return p;
}
async function draw(){
  CTX.setTransform(1,0,0,1,0,0);
  CTX.fillStyle = "#fff"; CTX.fillRect(0,0,W,H);

  // world origin centered
  const offsetX = (W - WORLD.size*SCALE)/2;
  const offsetY = (H - WORLD.size*SCALE)/2;

  // outlines
  CTX.lineWidth = Math.max(1, 0.8*DPR);
  CTX.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--outline').trim() || '#cfd6e3';

  for(const t of tiles){
    const x = Math.floor(offsetX + t.x * SCALE);
    const y = Math.floor(offsetY + t.y * SCALE);
    const w = Math.ceil(t.w * SCALE);
    const h = Math.ceil(t.h * SCALE);

    // content if claimed
    const claim = claims[t.id];
    if (claim){ await drawCover(claim.img, x,y,w,h); }

    // border
    CTX.strokeRect(x + 0.5, y + 0.5, w - 1, h - 1);
  }
}

async function drawCover(src, x,y,w,h){
  try{
    const im = await loadImg(src);
    const r = Math.max(w/im.width, h/im.height);
    const iw = im.width*r, ih = im.height*r;
    const ix = x + (w - iw)/2, iy = y + (h - ih)/2;
    CTX.fillStyle="#fff"; CTX.fillRect(x,y,w,h);
    CTX.drawImage(im, ix, iy, iw, ih);
  }catch(e){
    CTX.fillStyle="#f5e6a8"; CTX.fillRect(x,y,w,h);
  }
}

/* ===================== Hit testing ===================== */
function screenToWorld(px,py){
  const offsetX = (W - WORLD.size*SCALE)/2;
  const offsetY = (H - WORLD.size*SCALE)/2;
  const wx = (px*DPR - offsetX) / SCALE;
  const wy = (py*DPR - offsetY) / SCALE;
  return [wx,wy];
}
function pickTile(px,py){
  const [wx,wy] = screenToWorld(px,py);
  if (wx<0||wy<0||wx>WORLD.size||wy>WORLD.size) return null;
  // 3k тайлов — линейный поиск быстрый
  for (let i=tiles.length-1;i>=0;i--){
    const t=tiles[i];
    if (wx>=t.x && wy>=t.y && wx<=t.x+t.w && wy<=t.y+t.h) return t;
  }
  return null;
}
CAN.addEventListener('click', e=>{
  const rect = CAN.getBoundingClientRect();
  const t = pickTile(e.clientX-rect.left, e.clientY-rect.top);
  if (!t) return;
  const claim = claims[t.id];
  if (claim) openView(claim);
  else openAdd(t);
});

/* ===================== Modals ===================== */
const viewOverlay = document.getElementById('viewOverlay');
const viewImg = document.getElementById('viewImg');
const viewTitle = document.getElementById('viewTitle');
const viewSub = document.getElementById('viewSub');
document.getElementById('viewClose').onclick = ()=> viewOverlay.classList.remove('on');
viewOverlay.addEventListener('click',e=>{ if(e.target===viewOverlay) viewOverlay.classList.remove('on'); });

const addOverlay = document.getElementById('addOverlay');
const addCancel  = document.getElementById('addCancel');
const addSave    = document.getElementById('addSave');
const drop       = document.getElementById('drop');
const file       = document.getElementById('file');
const preview    = document.getElementById('preview');
const dropText   = document.getElementById('dropText');
const desc       = document.getElementById('desc');
let addRect = null;

function openView(rec){
  viewTitle.textContent = rec.name || "Member of the Golden Million";
  viewSub.textContent = rec.desc || "“A short line for history.”";
  viewImg.src = rec.img; viewOverlay.classList.add('on');
}
function openAdd(t){
  addRect = t;
  preview.style.display='none'; preview.src=''; dropText.textContent='Drop an image here (or click)'; desc.value='';
  addOverlay.classList.add('on');
}

drop.addEventListener('click', ()=> file.click());
drop.addEventListener('dragover',e=>{ e.preventDefault(); drop.style.borderColor="#999"; });
drop.addEventListener('dragleave',()=>{ drop.style.borderColor="#cfd3da"; });
drop.addEventListener('drop',e=>{
  e.preventDefault(); drop.style.borderColor="#cfd3da";
  if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
file.addEventListener('change',e=>{ if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]); });

function handleFile(f){
  if(!/^image\//.test(f.type)) return alert("Please choose an image");
  const r=new FileReader(); r.onload=()=>{ preview.src=r.result; preview.style.display='block'; dropText.textContent='Image selected'; }; r.readAsDataURL(f);
}

addCancel.onclick = ()=> addOverlay.classList.remove('on');
addOverlay.addEventListener('click',e=>{ if(e.target===addOverlay) addOverlay.classList.remove('on'); });

addSave.onclick = async ()=>{
  if (!addRect) return;
  if (!preview.src) return alert("Please add an image first.");
  // compress to WebP; target based on tile short side (in world cells)
  const shortSide = Math.min(addRect.w, addRect.h);
  const img = await downscaleToWebP(preview.src, Math.max(240, Math.round(shortSide*0.9)));
  claims[addRect.id] = { img, name:"Golden Million Member", desc:(desc.value||"I was here.").slice(0,80) };
  persist();
  addOverlay.classList.remove('on');
  draw();
};

/* Compress to WebP safely (prevents quota errors) */
function loadImgBlob(src){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; }); }
async function downscaleToWebP(dataURL, targetShort){
  const im = await loadImgBlob(dataURL);
  const short = Math.min(im.width, im.height);
  const scale = Math.min(1, targetShort/short);
  const w = Math.max(180, Math.round(im.width*scale));
  const h = Math.max(180, Math.round(im.height*scale));
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const g = c.getContext('2d'); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';
  g.drawImage(im, 0,0,w,h);
  let out = c.toDataURL('image/webp', 0.86);
  if (out.length > 4_500_000) out = c.toDataURL('image/jpeg', 0.86);
  return out;
}

/* ===================== GO ===================== */
resize(); // initial draw
</script>
</body>
</html>
